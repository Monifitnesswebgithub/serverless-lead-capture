import json
import boto3
import uuid
from datetime import datetime

# Initialize the DynamoDB client, ensuring table name consistency
dynamodb = boto3.resource('dynamodb')
# *** CRITICAL: MUST MATCH YOUR DYNAMODB TABLE NAME ***
table = dynamodb.Table('BlackTigerContactQueriesTable') 

def lambda_handler(event, context):
    try:
        # Load the data sent by API Gateway (which is JSON string in event['body'])
        if 'body' not in event or not event['body']:
            raise ValueError("No request body found.")

        data = json.loads(event['body'])
        
        # --- Data Extraction ---
        name = data.get('name')
        email = data.get('email')
        query_message = data.get('query') # Key must match 'query' from script.js

        if not name or not email or not query_message:
            raise ValueError("Missing required form fields.")
        
        # --- Data Processing and DynamoDB Write ---
        query_id = str(uuid.uuid4())
        submission_date = datetime.utcnow().isoformat()

        item = {
            'queryId': query_id,
            'submissionDate': submission_date,
            'name': name,
            'email': email,
            'queryMessage': query_message 
        }

        # Put the item into the DynamoDB table (This requires IAM permission!)
        table.put_item(Item=item)

        # Successful HTTP 200 Response with CORS headers
        return {
            'statusCode': 200,
            'headers': {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*', 
                'Access-Control-Allow-Methods': 'POST,OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'
            },
            'body': json.dumps({'message': 'Query successfully received! We will contact you shortly.'})
        }
        
    except Exception as e:
        # Log the error (this should now appear in CloudWatch)
        print(f"ERROR: Lambda execution failed: {e}")
        
        # Consistent HTTP 500 Error Response with CORS headers
        return {
            'statusCode': 500,
            'headers': {
                'Access-Control-Allow-Origin': '*' # Crucial CORS header for errors
            },
            'body': json.dumps({'error': f'Failed to process inquiry due to internal error: {str(e)}'})
        }